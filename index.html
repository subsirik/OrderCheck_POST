<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>หน่วยพัฒนาและจำหน่ายผลิตภัณฑ์ — ค้นหาจากรหัส/ชื่อ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <header class="bg-white shadow-lg border-b-4 border-indigo-600">
    <div class="container mx-auto px-6 py-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
            หน่วยพัฒนาและจำหน่ายผลิตภัณฑ์
          </h1>
          <p class="text-sm text-gray-600">สโมสรนักศึกษาคณะมนุษยศาสตร์ มหาวิทยาลัยเชียงใหม่</p>
        </div>
        <div class="text-sm text-gray-500">ค้นหาด้วยรหัสนักศึกษา หรือ ชื่อ–สกุล จาก Firestore</div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <!-- Search Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
      <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">คำค้น</label>
          <input id="q" type="text" placeholder="พิมพ์รหัสนักศึกษาหรือชื่อขึ้นต้น (เช่น 66xxxxxxx / สมชาย)"
                 class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2" />
          <p class="text-xs text-gray-500 mt-1">
            กด <kbd class="px-1 rounded bg-gray-100 border">Enter</kbd> เพื่อค้นหา • รองรับ exact และ partial (ขึ้นต้น)
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ค้นหาตาม</label>
          <select id="mode" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2">
            <option value="studentId">รหัสประจำตัวนักศึกษา (Student ID)</option>
            <option value="fullName">ชื่อ - สกุล (Name - Surname)</option>
          </select>
        </div>
      </div>
      <div class="flex gap-3 mt-4">
        <button id="btnSearch" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl">ค้นหา</button>
        <button id="btnClear" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-xl">ล้างผลลัพธ์</button>
      </div>
    </div>

    <!-- Result Summary -->
    <div id="summary" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-4 border-l-4 border-indigo-500">
        <p class="text-gray-800">
          ผลการค้นหา: <span id="count" class="font-semibold">0</span> รายการ
          <span id="lastUpdated" class="text-xs text-gray-500 ml-2"></span>
        </p>
      </div>
    </div>

    <!-- Results Table -->
    <div class="mt-4 bg-white rounded-2xl shadow overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">#</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">รหัสประจำตัวนักศึกษา</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ชื่อ - สกุล</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ออเดอร์สินค้า</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">จำนวน</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ที่อยู่</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tracking No.</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">คัดลอก</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-gray-200"></tbody>
      </table>
      <div id="emptyState" class="p-8 text-center text-gray-500 hidden">ไม่มีผลลัพธ์ ลองแก้คำค้นแล้วค้นหาใหม่</div>
    </div>
  </main>

  <!-- Firebase + App (Module) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, query, where, getDocs, orderBy, limit, startAt, endAt
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // === ใช้คอนฟิกเดิมของโปรเจกต์คุณ ===
    const firebaseConfig = {
      apiKey: "AIzaSyByuGxfKJcT-fcFZlfBF926Cyo1yXxwwTc",
      authDomain: "ordertrackkingsmo.firebaseapp.com",
      projectId: "ordertrackkingsmo",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== CONFIG =====
    const COLLECTION_NAME = 'orders';
    const F = {
      studentId:   'studentId',   // รหัสประจำตัวนักศึกษา
      fullName:    'fullName',    // ชื่อ - สกุล (เก็บเป็นสตริงเดียว เช่น "สมชาย ใจดี")
      merchandise: 'merchandise', // ออเดอร์สินค้า
      quantity:    'quantity',    // จำนวน
      address:     'address',     // ที่อยู่
      trackingNo:  'trackingNo',  // เลขพัสดุ
      createdAt:   'createdAt'
    };

    // ===== Elements =====
    const $ = (id) => document.getElementById(id);
    const qInput = $('q');
    const modeSel = $('mode');
    const btnSearch = $('btnSearch');
    const btnClear = $('btnClear');
    const tbody = $('tbody');
    const emptyState = $('emptyState');
    const summary = $('summary');
    const countSpan = $('count');
    const lastUpdated = $('lastUpdated');

    // ===== Helpers =====
    const fmt = (v) => (v ?? '').toString().trim() || '-';

    function renderRows(rows) {
      if (!rows.length) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        summary.classList.add('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      summary.classList.remove('hidden');
      countSpan.textContent = rows.length.toLocaleString();
      lastUpdated.textContent = `อัปเดตเมื่อ ${new Date().toLocaleString('th-TH')}`;

      tbody.innerHTML = rows.map((r, i) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-900">${i + 1}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.studentId])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.fullName])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.merchandise])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.quantity])}</td>
          <td class="px-4 py-3 text-sm text-gray-900 whitespace-pre-line">${fmt(r[F.address])}</td>
          <td class="px-4 py-3 text-sm font-semibold text-indigo-700">${fmt(r[F.trackingNo])}</td>
          <td class="px-4 py-3 text-sm">
            <button class="copyBtn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded"
                    data-copy="${fmt(r[F.trackingNo])}">คัดลอก</button>
          </td>
        </tr>
      `).join('');

      tbody.querySelectorAll('.copyBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const t = e.currentTarget.getAttribute('data-copy') || '';
          try {
            await navigator.clipboard.writeText(t);
            e.currentTarget.textContent = 'คัดลอกแล้ว';
            setTimeout(() => (e.currentTarget.textContent = 'คัดลอก'), 1200);
          } catch { alert('คัดลอกไม่สำเร็จ'); }
        });
      });
    }

    // ===== Search Logic =====
    async function search() {
      const termRaw = qInput.value.trim();
      const mode = modeSel.value;
      if (!termRaw) { renderRows([]); return; }

      // กำหนดฟิลด์เป้าหมายที่ใช้ค้นหา
      const FIELD = (mode === 'studentId') ? F.studentId : F.fullName;

      // 1) ลอง exact match ก่อน (สำหรับ ID/ชื่อที่พิมพ์ครบ)
      let q1;
      if (mode === 'studentId') {
        // รหัสนักศึกษา exact match
        q1 = query(collection(db, COLLECTION_NAME), where(FIELD, '==', termRaw), limit(20));
      } else {
        // ชื่อ exact match (ตรงตัว)
        q1 = query(collection(db, COLLECTION_NAME), where(FIELD, '==', termRaw), limit(20));
      }
      const snap1 = await getDocs(q1);
      const exact = snap1.docs.map(d => d.data());
      if (exact.length) { renderRows(exact); return; }

      // 2) ถ้าไม่เจอ ให้ทำ prefix (เริ่มต้นด้วย)
      // หมายเหตุ: ต้อง orderBy ที่ฟิลด์นั้น และ prefix ด้วย startAt / endAt
      const prefix = termRaw;
      const q2 = query(
        collection(db, COLLECTION_NAME),
        orderBy(FIELD),
        startAt(prefix),
        endAt(prefix + '\uf8ff'),
        limit(50)
      );
      const snap2 = await getDocs(q2);
      const partial = snap2.docs.map(d => d.data());
      renderRows(partial);
    }

    // ===== Events =====
    btnSearch.addEventListener('click', search);
    btnClear.addEventListener('click', () => { qInput.value = ''; renderRows([]); });
    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });
    window.addEventListener('DOMContentLoaded', () => qInput.focus());
  </script>

  <!--
  Firestore ข้อควรทราบ:
  1) ถ้าค้นหาแบบ prefix ไม่ขึ้น ให้สร้าง Index สำหรับ orderBy(FIELD) ในคอลเลกชัน "orders"
  2) ถ้าต้องการค้นหาชื่อแบบไม่สนตัวพิมพ์ (case-insensitive) แนะนำเก็บฟิลด์เพิ่ม เช่น fullNameLower และค้นหาด้วยค่านั้นแทน
  -->
</body>
</html>
