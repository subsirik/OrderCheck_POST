<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå ‚Äî ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg border-b-4 border-indigo-600">
    <div class="container mx-auto px-6 py-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
            ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå
          </h1>
          <p class="text-sm text-gray-600">‡∏™‡πÇ‡∏°‡∏™‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ì‡∏∞‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</p>
        </div>
        <div class="text-sm text-gray-500">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Firestore)</div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <!-- Search Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô</label>
          <input id="q" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 66xxxxxxx / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢)"
                 class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2" />
          <p class="text-xs text-gray-500 mt-1">
            ‡∏Å‡∏î <kbd class="px-1 rounded bg-gray-100 border">Enter</kbd> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö exact ‡πÅ‡∏•‡∏∞ partial (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô)
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°</label>
          <select id="mode" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2">
            <option value="studentId">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Student ID)</option>
            <option value="fullName">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• (Name - Surname)</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-3 mt-4">
        <button id="btnSearch" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button id="btnClear" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-xl">‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        <button id="btnLoadAll" class="bg-slate-600 hover:bg-slate-700 text-white px-5 py-2 rounded-xl">‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</button>
        <span id="err" class="text-sm text-rose-700"></span>
      </div>
    </div>

    <!-- Result Summary -->
    <div id="summary" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-4 border-l-4 border-indigo-500">
        <p class="text-gray-800">
          ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <span id="count" class="font-semibold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          <span id="lastUpdated" class="text-xs text-gray-500 ml-2"></span>
        </p>
      </div>
    </div>

    <!-- Results Table -->
    <div class="mt-4 bg-white rounded-2xl shadow overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">#</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tracking No.</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-gray-200"></tbody>
      </table>
      <div id="emptyState" class="p-8 text-center text-gray-500 hidden">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏•‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
    </div>
  </main>

  <!-- Firebase + App (Module) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, query, where, getDocs, orderBy, limit, startAt, endAt
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ===== Firebase Config (‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) =====
    const firebaseConfig = {
      apiKey: "AIzaSyByuGxfKJcT-fcFZlfBF926Cyo1yXxwwTc",
      authDomain: "ordertrackkingsmo.firebaseapp.com",
      projectId: "ordertrackkingsmo"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== CONFIG =====
    const COLLECTION_NAME = 'orders'; // ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
    const F = {
      studentId:   'studentId',   // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏∞‡∏Å‡∏î studentID ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      fullName:    'fullName',
      merchandise: 'merchandise',
      quantity:    'quantity',
      address:     'address',
      trackingNo:  'trackingNo',
      createdAt:   'createdAt'
    };

    // ===== Elements =====
    const $ = (id) => document.getElementById(id);
    const qInput = $('q');
    const modeSel = $('mode');
    const btnSearch = $('btnSearch');
    const btnClear = $('btnClear');
    const btnLoadAll = $('btnLoadAll');
    const tbody = $('tbody');
    const emptyState = $('emptyState');
    const summary = $('summary');
    const countSpan = $('count');
    const lastUpdated = $('lastUpdated');
    const errSpan = $('err');

    // ===== Helpers =====
    const fmt = (v) => (v ?? '').toString().trim() || '-';
    const showErr = (msg) => {
      errSpan.textContent = msg || '';
      if (msg) setTimeout(() => (errSpan.textContent = ''), 5000);
    };

    function renderRows(rows) {
      if (!rows.length) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        summary.classList.add('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      summary.classList.remove('hidden');
      countSpan.textContent = rows.length.toLocaleString();
      lastUpdated.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString('th-TH')}`;

      tbody.innerHTML = rows.map((r, i) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-900">${i + 1}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.studentId])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.fullName])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.merchandise])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.quantity])}</td>
          <td class="px-4 py-3 text-sm text-gray-900 whitespace-pre-line">${fmt(r[F.address])}</td>
          <td class="px-4 py-3 text-sm font-semibold text-indigo-700">${fmt(r[F.trackingNo])}</td>
          <td class="px-4 py-3 text-sm">
            <button class="copyBtn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded"
                    data-copy="${fmt(r[F.trackingNo])}">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          </td>
        </tr>
      `).join('');

      tbody.querySelectorAll('.copyBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const t = e.currentTarget.getAttribute('data-copy') || '';
          try {
            await navigator.clipboard.writeText(t);
            e.currentTarget.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            setTimeout(() => (e.currentTarget.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'), 1200);
          } catch { alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        });
      });
    }

    // ===== Diagnostics: Smoke Test on load =====
    async function smokeTest() {
      try {
        const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(1)));
        console.log('[SMOKE] docs in collection?', snap.size);
        if (snap.size === 0) {
          showErr('‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á (orders)');
        }
      } catch (e) {
        console.error('[SMOKE] error', e);
        showErr((e.code || e.message || '‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') + ' ‚Äî ‡∏ï‡∏£‡∏ß‡∏à Rules/Config');
      }
    }

    // ===== Fallback: client-side filter when prefix search not possible =====
    async function fallbackClientFilter(field, prefix) {
      try {
        // ‡∏•‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° createdAt ‡∏Å‡πà‡∏≠‡∏ô (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ index) ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏∂‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á
        try {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), orderBy(F.createdAt, 'desc'), limit(200)));
          const rows = snap.docs.map(d => d.data()).filter(r => String(r[field] ?? '').startsWith(prefix));
          if (!rows.length) showErr('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÇ‡∏´‡∏°‡∏î fallback ‡∏Å‡∏£‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏Ñ‡∏•‡πÄ‡∏≠‡∏ô‡∏ï‡πå)');
          renderRows(rows);
        } catch (e1) {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(200)));
          const rows = snap.docs.map(d => d.data()).filter(r => String(r[field] ?? '').startsWith(prefix));
          if (!rows.length) showErr('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (fallback ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Index)');
          renderRows(rows);
        }
      } catch (e) {
        console.error('fallback error', e);
        showErr(e.code || e.message || '‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }

    // ===== Search Logic (robust) =====
    async function search() {
      showErr('');
      const termRaw = qInput.value.trim();
      const mode = modeSel.value;
      if (!termRaw) { renderRows([]); return; }

      const FIELD = (mode === 'studentId') ? F.studentId : F.fullName;

      try {
        // 1) exact match (string)
        const eqStrSnap = await getDocs(query(collection(db, COLLECTION_NAME), where(FIELD, '==', termRaw), limit(20)));
        const eqStr = eqStrSnap.docs.map(d => d.data());
        if (eqStr.length) { renderRows(eqStr); return; }

        // 1.1) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô studentId ‡πÅ‡∏•‡∏∞ term ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô ‡∏•‡∏≠‡∏á exact ‡πÅ‡∏ö‡∏ö Number
        if (mode === 'studentId' && /^\d+$/.test(termRaw)) {
          const eqNumSnap = await getDocs(query(collection(db, COLLECTION_NAME), where(FIELD, '==', Number(termRaw)), limit(20)));
          const eqNum = eqNumSnap.docs.map(d => d.data());
          if (eqNum.length) { renderRows(eqNum); return; }
        }

        // 2) prefix match (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        try {
          const snap2 = await getDocs(query(
            collection(db, COLLECTION_NAME),
            orderBy(FIELD),
            startAt(termRaw),
            endAt(termRaw + '\uf8ff'),
            limit(50)
          ));
          const rows2 = snap2.docs.map(d => d.data());
          if (rows2.length) { renderRows(rows2); return; }
        } catch (e2) {
          // ‡∏ñ‡πâ‡∏≤ error (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ index) ‡∏à‡∏∞‡πÑ‡∏õ fallback
          console.warn('prefix search error -> fallback', e2);
        }

        // 3) Fallback: ‡∏î‡∏∂‡∏á 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏Ñ‡∏•‡πÄ‡∏≠‡∏ô‡∏ï‡πå (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
        await fallbackClientFilter(FIELD, termRaw);
      } catch (e) {
        console.error('search error', e);
        if ((e.code || '').includes('permission-denied')) {
          showErr('permission-denied: Rules ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô (‡∏ï‡∏±‡πâ‡∏á allow read: if true; ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à)');
        } else if ((e.code || '').includes('failed-precondition')) {
          showErr('‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏ï‡∏≤‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô Console (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")');
        } else {
          showErr(e.code || e.message || '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      }
    }

    // ===== Load-All (20) to verify reading works =====
    async function loadAll() {
      showErr('');
      try {
        try {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), orderBy(F.createdAt, 'desc'), limit(20)));
          renderRows(snap.docs.map(d => d.data()));
        } catch (e1) {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(20)));
          renderRows(snap.docs.map(d => d.data()));
          showErr('‡πÑ‡∏°‡πà‡∏°‡∏µ Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö orderBy(createdAt) ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
        }
      } catch (e) {
        console.error('loadAll error', e);
        showErr(e.code || e.message || '‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }

    // ===== Events =====
    btnSearch.addEventListener('click', search);
    btnClear.addEventListener('click', () => { qInput.value = ''; renderRows([]); showErr(''); });
    btnLoadAll.addEventListener('click', loadAll);
    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });

    window.addEventListener('DOMContentLoaded', () => {
      qInput.focus();
      smokeTest();
    });
  </script>

  <!--
  üß™ Firestore Rules ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /orders/{docId} {
        allow read: if true;   // ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™
        // allow write: if false;
      }
    }
  }

  ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô:
  - ‡πÄ‡∏ä‡πá‡∏Å‡∏ó‡∏µ‡πà Console (F12) ‡∏ß‡πà‡∏≤‡∏°‡∏µ error "permission-denied" ‡∏´‡∏£‡∏∑‡∏≠ "requires index" ‡πÑ‡∏´‡∏°
  - ‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô/‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏∞‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö F ‡πÑ‡∏´‡∏°
  - ‡∏•‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
  - ‡∏ñ‡πâ‡∏≤ studentId ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Number ‚Üí ‡∏Ñ‡πâ‡∏ô‡πÅ‡∏ö‡∏ö prefix ‡∏à‡∏∞‡πÉ‡∏ä‡πâ fallback (‡∏î‡∏∂‡∏á 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏á)
  -->
</body>
</html>
