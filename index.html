<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>หน่วยพัฒนาและจำหน่ายผลิตภัณฑ์ — ค้นหาคำสั่งซื้อ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg border-b-4 border-indigo-600">
    <div class="container mx-auto px-6 py-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
            หน่วยพัฒนาและจำหน่ายผลิตภัณฑ์
          </h1>
          <p class="text-sm text-gray-600">สโมสรนักศึกษาคณะมนุษยศาสตร์ มหาวิทยาลัยเชียงใหม่</p>
        </div>
        <div class="text-sm text-gray-500">ค้นหาด้วยรหัสนักศึกษา หรือ ชื่อ–สกุล (อ่านจาก Firestore)</div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <!-- Search Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">ค้นหาคำสั่งซื้อ</h2>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">คำค้น</label>
          <input id="q" type="text" placeholder="พิมพ์รหัสนักศึกษาหรือชื่อขึ้นต้น (เช่น 66xxxxxxx / สมชาย)"
                 class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2" />
          <p class="text-xs text-gray-500 mt-1">
            กด <kbd class="px-1 rounded bg-gray-100 border">Enter</kbd> เพื่อค้นหา • รองรับ exact และ partial (ขึ้นต้น)
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ค้นหาตาม</label>
          <select id="mode" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 px-4 py-2">
            <option value="studentId">รหัสประจำตัวนักศึกษา (Student ID)</option>
            <option value="fullName">ชื่อ - สกุล (Name - Surname)</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-3 mt-4">
        <button id="btnSearch" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl">ค้นหา</button>
        <button id="btnClear" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-xl">ล้างผลลัพธ์</button>
        <button id="btnLoadAll" class="bg-slate-600 hover:bg-slate-700 text-white px-5 py-2 rounded-xl">โหลดทั้งหมด (20 รายการ)</button>
        <span id="err" class="text-sm text-rose-700"></span>
      </div>
    </div>

    <!-- Result Summary -->
    <div id="summary" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-4 border-l-4 border-indigo-500">
        <p class="text-gray-800">
          ผลการค้นหา: <span id="count" class="font-semibold">0</span> รายการ
          <span id="lastUpdated" class="text-xs text-gray-500 ml-2"></span>
        </p>
      </div>
    </div>

    <!-- Results Table -->
    <div class="mt-4 bg-white rounded-2xl shadow overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">#</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">รหัสประจำตัวนักศึกษา</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ชื่อ - สกุล</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ออเดอร์สินค้า</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">จำนวน</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ที่อยู่</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tracking No.</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">คัดลอก</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-gray-200"></tbody>
      </table>
      <div id="emptyState" class="p-8 text-center text-gray-500 hidden">ไม่มีผลลัพธ์ ลองแก้คำค้นแล้วค้นหาใหม่</div>
    </div>
  </main>

  <!-- Firebase + App (Module) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, query, where, getDocs, orderBy, limit, startAt, endAt
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ===== Firebase Config (โปรเจกต์ของคุณ) =====
    const firebaseConfig = {
      apiKey: "AIzaSyByuGxfKJcT-fcFZlfBF926Cyo1yXxwwTc",
      authDomain: "ordertrackkingsmo.firebaseapp.com",
      projectId: "ordertrackkingsmo"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== CONFIG =====
    const COLLECTION_NAME = 'orders'; // แก้ให้ตรงชื่อคอลเลกชันจริง
    const F = {
      studentId:   'studentId',   // ถ้าของจริงสะกด studentID ให้แก้ตรงนี้
      fullName:    'fullName',
      merchandise: 'merchandise',
      quantity:    'quantity',
      address:     'address',
      trackingNo:  'trackingNo',
      createdAt:   'createdAt'
    };

    // ===== Elements =====
    const $ = (id) => document.getElementById(id);
    const qInput = $('q');
    const modeSel = $('mode');
    const btnSearch = $('btnSearch');
    const btnClear = $('btnClear');
    const btnLoadAll = $('btnLoadAll');
    const tbody = $('tbody');
    const emptyState = $('emptyState');
    const summary = $('summary');
    const countSpan = $('count');
    const lastUpdated = $('lastUpdated');
    const errSpan = $('err');

    // ===== Helpers =====
    const fmt = (v) => (v ?? '').toString().trim() || '-';
    const showErr = (msg) => {
      errSpan.textContent = msg || '';
      if (msg) setTimeout(() => (errSpan.textContent = ''), 5000);
    };

    function renderRows(rows) {
      if (!rows.length) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        summary.classList.add('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      summary.classList.remove('hidden');
      countSpan.textContent = rows.length.toLocaleString();
      lastUpdated.textContent = `อัปเดตเมื่อ ${new Date().toLocaleString('th-TH')}`;

      tbody.innerHTML = rows.map((r, i) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-900">${i + 1}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.studentId])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.fullName])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.merchandise])}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${fmt(r[F.quantity])}</td>
          <td class="px-4 py-3 text-sm text-gray-900 whitespace-pre-line">${fmt(r[F.address])}</td>
          <td class="px-4 py-3 text-sm font-semibold text-indigo-700">${fmt(r[F.trackingNo])}</td>
          <td class="px-4 py-3 text-sm">
            <button class="copyBtn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded"
                    data-copy="${fmt(r[F.trackingNo])}">คัดลอก</button>
          </td>
        </tr>
      `).join('');

      tbody.querySelectorAll('.copyBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const t = e.currentTarget.getAttribute('data-copy') || '';
          try {
            await navigator.clipboard.writeText(t);
            e.currentTarget.textContent = 'คัดลอกแล้ว';
            setTimeout(() => (e.currentTarget.textContent = 'คัดลอก'), 1200);
          } catch { alert('คัดลอกไม่สำเร็จ'); }
        });
      });
    }

    // ===== Diagnostics: Smoke Test on load =====
    async function smokeTest() {
      try {
        const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(1)));
        console.log('[SMOKE] docs in collection?', snap.size);
        if (snap.size === 0) {
          showErr('คอลเลกชันว่าง หรือชื่อคอลเลกชันไม่ตรง (orders)');
        }
      } catch (e) {
        console.error('[SMOKE] error', e);
        showErr((e.code || e.message || 'อ่านข้อมูลไม่สำเร็จ') + ' — ตรวจ Rules/Config');
      }
    }

    // ===== Fallback: client-side filter when prefix search not possible =====
    async function fallbackClientFilter(field, prefix) {
      try {
        // ลองจัดเรียงตาม createdAt ก่อน (อาจต้องมี index) ไม่งั้นค่อยดึงแบบไม่เรียง
        try {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), orderBy(F.createdAt, 'desc'), limit(200)));
          const rows = snap.docs.map(d => d.data()).filter(r => String(r[field] ?? '').startsWith(prefix));
          if (!rows.length) showErr('ไม่พบผลลัพธ์ (โหมด fallback กรองฝั่งไคลเอนต์)');
          renderRows(rows);
        } catch (e1) {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(200)));
          const rows = snap.docs.map(d => d.data()).filter(r => String(r[field] ?? '').startsWith(prefix));
          if (!rows.length) showErr('ไม่พบผลลัพธ์ (fallback ไม่เรียง เพราะยังไม่มี Index)');
          renderRows(rows);
        }
      } catch (e) {
        console.error('fallback error', e);
        showErr(e.code || e.message || 'อ่านข้อมูลไม่สำเร็จ');
      }
    }

    // ===== Search Logic (robust) =====
    async function search() {
      showErr('');
      const termRaw = qInput.value.trim();
      const mode = modeSel.value;
      if (!termRaw) { renderRows([]); return; }

      const FIELD = (mode === 'studentId') ? F.studentId : F.fullName;

      try {
        // 1) exact match (string)
        const eqStrSnap = await getDocs(query(collection(db, COLLECTION_NAME), where(FIELD, '==', termRaw), limit(20)));
        const eqStr = eqStrSnap.docs.map(d => d.data());
        if (eqStr.length) { renderRows(eqStr); return; }

        // 1.1) ถ้าเป็น studentId และ term เป็นตัวเลขล้วน ลอง exact แบบ Number
        if (mode === 'studentId' && /^\d+$/.test(termRaw)) {
          const eqNumSnap = await getDocs(query(collection(db, COLLECTION_NAME), where(FIELD, '==', Number(termRaw)), limit(20)));
          const eqNum = eqNumSnap.docs.map(d => d.data());
          if (eqNum.length) { renderRows(eqNum); return; }
        }

        // 2) prefix match (ต้องเป็นฟิลด์ชนิดสตริงในฐานข้อมูล)
        try {
          const snap2 = await getDocs(query(
            collection(db, COLLECTION_NAME),
            orderBy(FIELD),
            startAt(termRaw),
            endAt(termRaw + '\uf8ff'),
            limit(50)
          ));
          const rows2 = snap2.docs.map(d => d.data());
          if (rows2.length) { renderRows(rows2); return; }
        } catch (e2) {
          // ถ้า error (เช่น มีชนิดข้อมูลอื่น หรือยังไม่มี index) จะไป fallback
          console.warn('prefix search error -> fallback', e2);
        }

        // 3) Fallback: ดึง 200 รายการมากรองฝั่งไคลเอนต์ (ชั่วคราว)
        await fallbackClientFilter(FIELD, termRaw);
      } catch (e) {
        console.error('search error', e);
        if ((e.code || '').includes('permission-denied')) {
          showErr('permission-denied: Rules ไม่อนุญาตให้อ่าน (ตั้ง allow read: if true; ชั่วคราวเพื่อตรวจ)');
        } else if ((e.code || '').includes('failed-precondition')) {
          showErr('ต้องสร้าง Index ตามลิงก์ที่ขึ้นใน Console (หรือใช้ปุ่ม "โหลดทั้งหมด")');
        } else {
          showErr(e.code || e.message || 'ค้นหาไม่สำเร็จ');
        }
      }
    }

    // ===== Load-All (20) to verify reading works =====
    async function loadAll() {
      showErr('');
      try {
        try {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), orderBy(F.createdAt, 'desc'), limit(20)));
          renderRows(snap.docs.map(d => d.data()));
        } catch (e1) {
          const snap = await getDocs(query(collection(db, COLLECTION_NAME), limit(20)));
          renderRows(snap.docs.map(d => d.data()));
          showErr('ไม่มี Index สำหรับ orderBy(createdAt) — แสดงแบบไม่เรียงชั่วคราว');
        }
      } catch (e) {
        console.error('loadAll error', e);
        showErr(e.code || e.message || 'อ่านข้อมูลไม่สำเร็จ');
      }
    }

    // ===== Events =====
    btnSearch.addEventListener('click', search);
    btnClear.addEventListener('click', () => { qInput.value = ''; renderRows([]); showErr(''); });
    btnLoadAll.addEventListener('click', loadAll);
    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });

    window.addEventListener('DOMContentLoaded', () => {
      qInput.focus();
      smokeTest();
    });
  </script>

  <!--
  🧪 Firestore Rules ทดสอบ (อ่านได้จากหน้าเว็บ)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /orders/{docId} {
        allow read: if true;   // เปิดอ่านชั่วคราวเพื่อเทส
        // allow write: if false;
      }
    }
  }

  ถ้ายังไม่ขึ้น:
  - เช็กที่ Console (F12) ว่ามี error "permission-denied" หรือ "requires index" ไหม
  - คอลเลกชัน/ฟิลด์สะกดตรงกับ F ไหม
  - ลองปุ่ม "โหลดทั้งหมด" เพื่อตรวจการอ่านพื้นฐาน
  - ถ้า studentId เก็บเป็น Number → ค้นแบบ prefix จะใช้ fallback (ดึง 200 รายการมากรอง)
  -->
</body>
</html>
